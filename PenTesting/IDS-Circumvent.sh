#! /bin/bash

## Time of script start
start=`date +%s`

## Create functions for output
ok_text(){
  echo -e "[  \033[0;32mOK\033[0m  ] "$1
}

info_text(){
  echo -e "[ \033[0;34mINFO\033[0m ] "$1
}

error_text(){
  echo -e "[ \033[0;31mFAIL\033[0m ] "$1
}

change_ip(){
  ifconfig $1 $2 netmask 255.255.255.0
  dhclient &> /dev/null
}

file_write(){
  echo $1 >> $2.txt
}

host_test(){
  ok_text "Testing host : "$1

  # Ping host and see if "errors" in output, 1 if yes, 0 of no
  #   (ping will wait 167ms before aborting scan, this means 3 hosts are scanned in 501ms
  #   evading the IDS as closly as possible)
   check=$(ping -c 1 -i 0.167 $1 | grep errors | wc -l)

   wait

  # If the host is alive, add to targets, if not add to available hosts
   if [ $check -eq 0 ]
   then
     echo $1 >> active.txt
   else
    echo $1 >> available.txt
   fi
}

host_scan(){
  # Portscan and grep / wc to just return 1 or 0 if the port is open or closed
  portScan=$(nmap -p $1 $2 | grep open | wc -l)

  # If the port is open, tell me, do nothing if not
  if [ $portScan -eq 1 ]
  then
    ok_text "Port "$1" on host "$2" is open"
    echo "$2 : $1" >> "$fileName-output.txt"
  fi
}

# Clear the screen
clear

# Show introduction ASCII text
echo "### ######   #####      #####"
echo " #  #     # #     #    #     # # #####   ####  #    # #    # #    # ###### #    # #####"
echo " #  #     # #          #       # #    # #    # #    # ##  ## #    # #      ##   #   #"
echo " #  #     #  #####     #       # #    # #      #    # # ## # #    # #####  # #  #   #"
echo " #  #     #       #    #       # #####  #      #    # #    # #    # #      #  # #   #"
echo " #  #     # #     #    #     # # #   #  #    # #    # #    #  #  #  #      #   ##   #"
echo "### ######   #####      #####  # #    #  ####   ####  #    #   ##   ###### #    #   #"
echo ""
echo "By up837417"
echo ""

## Check if sudo is running (because of ping interval)
if [ "$EUID" -ne 0 ]
  then error_text "Please run as root"
  exit
fi

# Generate an array of all possible IP combinations
Hosts=($(seq 1 2))

# Get the systems network adapter
adapterR=$(ip -o link show | awk '{print $2,$9}' | grep UP)
adapter=${adapterR%:*}
# Get the scripts base name
fileNameR=`basename $0`
fileName=${fileNameR%.*}

# Get the system's IP address
IP=$(hostname -I)

## Concat this to the network prefix
address=${IP%.*}.

## Ports to test
ports=(21 22 23 53 79 80 123)

for host in ${Hosts[@]}; do
# Create the IP to test
  hostIP=$address$host

# Check to ensure the script is not scanning the host it is running on
if [ $hostIP != $IP ]
then
  # Test the host but allow for multiple processes
  host_test $hostIP &
  # Delay for 0.167 seconds allowingf for 3 hosts to be scanned in 501ms
  sleep 0.167
  fi
done
# Wait for all the processes to finish
wait

## Create 2 arrays to hold alive and available hosts
aHosts=( $(<available.txt))
targets=( $(<active.txt))

info_text "Scanning identified targets"

# For each of the targets
for t in ${targets[@]}; do
  # For each of the ports we want to scan
  for p in ${ports[@]}; do
    # Randomise the IP
    change_ip $adapter ${aHosts[$RANDOM % ${#aHosts[@]} ] }

    host_scan $p $t &

    wait

  done
done

ok_text "Scan complete, reverting to original IP"
# Revert to original IP address
change_ip $adapter $IP

ok_text "Cleaning up"
rm active.txt
rm available.txt

ok_text "----------------------------"

# get stats after completion
for p in ${ports[@]}; do
  noOfHosts=$(more $fileName-output.txt | grep $p | wc -l)
  ok_text "Hosts that have port $p open : $noOfHosts"
done

end=`date +%s`

ok_text "Finished, time took:$((end-start))s"
